# 粒子解析プログラムの使い方ガイド

このプログラムは、顕微鏡写真のような専門的な画像（TIFF画像と呼ばれます）に写っているたくさんの小さな粒子を、自動で数えたり、大きさを測ったりするためのツールです。

複数の画像を一度にまとめて解析する「バッチ処理」機能が備わっており、たくさんのデータを効率的に扱えます。

このガイドでは、プログラミングに詳しくない方でも、手順通りに進めればプログラムを使えるように、丁寧に説明します。

## 1. 準備編：プログラムを動かす前に

まず、お使いのパソコンでプログラムを動かすための準備をします。

### ステップ1：プログラムをダウンロードする

はじめに、この粒子解析プログラムのファイル一式をお使いのパソコンにダウンロードします。

1.  **プログラムが配布されているWebページ（例: GitHub）にアクセスします。**
2.  **ファイル一式をZIPファイルとしてダウンロードします。**
    *   GitHubの場合、緑色の「Code」ボタンを押し、メニューから「Download ZIP」を選択するとダウンロードできます。
3.  **ダウンロードしたZIPファイルを解凍（展開）します。**
    *   ダウンロードしたファイル（例: `particle_analyze-main.zip`）をダブルクリックするか、右クリックメニューから「すべて展開」などを選んでください。
    *   解凍してできたフォルダ（例: `particle_analyze-main`）を、デスクトップなどの分かりやすい場所に置いてください。このフォルダがプログラムの本体になります。

### ステップ2：必要なものをインストールする

このプログラムは、いくつかの専門的な計算ツール（ライブラリと呼びます）の助けを借りて動きます。
以下の手順で、それらをパソコンにインストールしましょう。

1.  **ターミナル（またはコマンドプロンプト）を開きます。**
    *   **Macの場合:** `アプリケーション`フォルダの中の`ユーティリティ`フォルダにある`ターミナル.app`を開きます。
    *   **Windowsの場合:** スタートメニューで`cmd`と検索して、`コマンドプロンプト`を開きます。

2.  **以下の呪文（コマンド）をコピーして、ターミナルに貼り付け、Enterキーを押します。**
    これにより、必要なツールが一括でインストールされます。

    ```bash
    pip install opencv-python numpy matplotlib scikit-image scikit-learn tqdm
    ```

    （もし`pip`というコマンドが無いとエラーが出た場合は、先にPython本体のインストールが必要です。その際は別途ご相談ください。）

### ステップ3：解析したい画像を指定する

次に、あなたが解析したいご自身の画像ファイルを、プログラムに教えてあげる必要があります。

1.  **ステップ1で用意したプログラムのフォルダ（例: `particle_analyze-main`）の中にある`main.py`というファイルを開きます。**
    このファイルは、プログラムの設計図のようなものです。メモ帳やテキストエディタで開くことができます。

2.  **ファイルの中の`paths = [...]`と書かれている部分を探します。**
    はじめは、以下のように書かれているはずです。

    ```python
    paths = [
        "path/to/binary_image_stack_01.tif",
        "path/to/binary_image_stack_02.tif",
        "path/to/binary_image_stack_03.tif",
    ]
    ```

3.  **`"path/to/..."`の部分を、あなたが解析したい画像の場所（パス）に書き換えます。**
    ファイルのパスを一つ一つ指定することも、画像が入ったフォルダのパスを指定してまとめて処理することもできます。

    **書き換え方の例：**

    *   **ファイルを個別に指定する場合**
        カンマ`,`で区切って、解析したい画像をいくつでも追加できます。一つだけでも構いません。

        *   **Macの例:**
            （`your_username`の部分は、ご自身のユーザー名に置き換えてください）

            ```python
            paths = [
                "/Users/your_username/Desktop/image1.tif",
                "/Users/your_username/Desktop/image2.tif",
            ]
            ```

        *   **Windowsの例:**
            （`your_username`の部分は、ご自身のユーザー名に置き換えてください）

            ```python
            paths = [
                "C:/Users/your_username/Documents/image_A.tif",
                "C:/Users/your_username/Documents/image_B.tif",
            ]
            ```
            **（注意：Windowsの場合、パスの区切り文字`\`は`/`に置き換えてください）**

    *   **フォルダをまとめて指定する場合**
        特定のフォルダの中にある画像（`.tif`または`.tiff`）をすべて解析したい場合は、フォルダのパスを一つだけ指定します。
        
        ```python
        paths = [
            "/Users/your_username/Desktop/my_image_folder",
        ]
        ```
        このように指定すると、プログラムが自動でフォルダの中の画像を探して、すべて解析してくれます。

4.  **ファイルを上書き保存します。**

これで準備は完了です！

## 2. 実行編：プログラムを動かしてみる

いよいよプログラムを実行して、画像の解析を始めます。

1.  **準備編で使ったターミナル（またはコマンドプロンプト）を再度開きます。**

2.  **このプログラム（`particle_analyze`フォルダ）が置いてある場所に移動します。**
    （もし開き方が分からなければ、`particle_analyze`フォルダをターミナルのアイコンにドラッグ＆ドロップしてみてください）

3.  **以下の呪文（コマンド）をコピーして、ターミナルに貼り付け、Enterキーを押します。**

    ```bash
    python main.py
    ```

4.  **解析が始まります。** 進行状況を示すバーが表示され、パソコンが計算を頑張るので、少し時間がかかる場合があります。じっと待っていてください。
    ターミナルに特に何もエラーメッセージが表示されなければ、成功です。

## 3. 結果編：解析されたデータを見てみる

解析が終わると、`particle_analyze`フォルダの中に`dist`という新しいフォルダが作られ、その中に結果が保存されます。

`dist`フォルダの中は、さらに以下のように分かれています。

*   `dist/detected/`
    *   プログラムが「これが粒子だ」と認識した部分を、カラフルに色付けした画像が入っています。元画像と見比べて、正しく認識できているか確認できます。

*   `dist/segmented/`
    *   プログラムが粒子をどのように切り分けたかを示す、少し専門的な画像です。

*   `dist/histogram/`
    *   見つかった粒子の**大きさ（直径）** をグラフにした画像（ヒストグラム）です。どのくらいの大きさの粒子が、それぞれ何個くらいあったかが一目で分かります。

*   `dist/csv/`
    *   見つかった粒子一つ一つの**直径の生データ**が記録されたファイルです。Excelなどで開くことができ、ご自身でさらに詳しい分析をしたい場合に使えます。

*   `dist/summary/`
    *   各画像の解析結果をまとめた**サマリー（要約）ファイル**です。粒子の数、大きさの平均値・最大値・最小値などが記録されており、画像ごとの特徴を比較するのに便利です。

## 4. 詳細設定とカスタマイズ (上級者向け)

ここでは、より高度な使い方や、解析条件をご自身の実験データに合わせて調整する方法を解説します。
Pythonのコードを直接編集するため、少し慎重に作業を行ってください。

### 4.1 `main.py` の中身と解析の流れ

`main.py` はこのプログラムの司令塔です。主に以下の手順で処理が進みます。

1.  **設定の読み込み (`Config`)**
    *   解析に必要なパラメータ（ピクセルサイズや閾値など）を `modules/config.py` から読み込みます。
2.  **画像ごとの解析 (`ParticleAnalyzer`)**
    *   `paths` で指定されたリストから画像パスを一つずつ取り出し、解析を行います。
    *   ここで画像の前処理（ノイズ除去）、二値化、粒子の検出が行われます。
3.  **バッチ処理と集計 (`BatchParticleAnalyzer`)**
    *   全ての画像の解析が終わったら、それらの結果をまとめて集計します。
    *   ヒストグラムの作成や、結果CSVの保存はこの段階で行われます。

もし解析の挙動を変えたい場合は、主に **`modules/config.py`** の値を変更することで対応できます。

### 4.2 `modules/config.py` での設定変更

`modules/config.py` ファイルを開くと、解析の感度や単位変換に関する重要な数値が設定されています。
ご自身の顕微鏡の倍率や、対象とする粒子の特徴に合わせて以下の値を調整してください。

#### 物理パラメータ（単位変換）

*   **`DOTS_PER_MICRON`**
    *   **意味:** 画像の1マイクロメートルあたりに含まれるピクセル（ドット）数です。
    *   **計算方法:** `(画像の解像度[px]) / (画像の実際の幅[μm])`
    *   **設定例:** もし「1024pxの画像が実際には212.13μmの範囲を写している」なら、`1024 / 212.13` と入力します。ここが間違っていると、計算される粒子の大きさが全てズレてしまうので、最も重要な設定です。
*   **`SLICE_STEP_MICRON`**
    *   （3D画像の場合のみ関係します。通常の2D画像では無視して構いません）

#### 粒子フィルタリングパラメータ（ゴミの除去）

*   **`MIN_DIAMETER_MICRON`**
    *   **意味:** 解析対象とする粒子の**最小直径（μm）**です。
    *   **役割:** これより小さい「点」はノイズやゴミとみなされ、無視されます。明らかに小さすぎるゴミがたくさん検出されてしまう場合は、この値を少し大きくしてください（例: `1.0` -> `1.5`）。
*   **`MIN_CIRCULARITY`**
    *   **意味:** 解析対象とする粒子の**真円度（形の丸さ）**の最小値です。
    *   **範囲:** 0.0（複雑な形）〜 1.0（完全な円）
    *   **役割:** 形がいびつなゴミや、重なり合って変な形に見える粒子を除外するのに使います。
    *   **設定のコツ:**
        *   綺麗な円形の粒子だけを数えたい場合: `0.8` 以上など高めに設定。
        *   少し潰れた楕円形の粒子も数えたい場合: `0.5` 〜 `0.6` 程度に下げる。

#### 出力設定

*   **`DEFAULT_HISTOGRAM_BIN_WIDTH`**
    *   **意味:** ヒストグラム（棒グラフ）を作成するときの、棒1本分の幅（μm）です。
    *   **設定例:** `0.5` に設定すると、0.0-0.5μm, 0.5-1.0μm... という刻みでグラフが作られます。分布をより細かく見たい場合は値を小さくし、大まかな傾向を見たい場合は値を大きくします。

---

### 4.3 `main.py` での解析実行オプション（詳細設定）

`main.py` の最後にある、`batch_analyzer` から始まる行を変更することで、出力結果を細かくカスタマイズできます。
カッコ `()` の中にオプションを指定することで、以下の機能が利用できます。

#### ヒストグラムの見た目を調整する (`plot_diameter_histogram`)

グラフの軸の範囲や、ビンの幅を変更できます。複数の画像を比較する際に、軸を統一するのに便利です。

*   **`xlim=(最小, 最大)`**: 横軸（粒子直径 μm）の表示範囲を固定します。
*   **`ylim=(最小, 最大)`**: 縦軸（度数または割合）の表示範囲を固定します。
*   **`bin_width=数値`**: ヒストグラムの棒1本分の幅（μm）を変更します（`config.py`の設定より優先されます）。
*   **`density=True/False`**:
    *   `True` (デフォルト): 縦軸を「相対度数（全体に対する割合）」で表示します。
    *   `False`: 縦軸を「粒子の個数」で表示します。

**記述例:**
```python
# 横軸を0〜10μm、縦軸を0〜0.5(50%)に固定し、0.2μm刻みでグラフ化
# 画像ごとのタイトルを表示しない場合は add_title=False とする
batch_analyzer.plot_diameter_histogram(xlim=(0, 10), ylim=(0, 0.5), bin_width=0.2, add_title=False)
```

その他のオプション（上級者向け）:
*   **`add_title=True/False`**: グラフの上部に画像名を表示するかどうか（デフォルトはTrue）。
*   **`upper_limit=数値`**: ヒストグラム計算上の最大直径の上限を指定します（xlimとは別に計算に使用される場合があります）。

#### 特定のサイズの粒子を数える (`output_summary_csv`)

「1μm以下の粒子が何個あるか」など、特定の範囲にある粒子の数や割合を集計してCSVに出力できます。

*   **`ranges=[(最小, 最大), ...]`**: 集計したい範囲のリストを指定します。
    *   `None` は「制限なし（無限）」を意味します。
*   **`title="ファイル名"`**: 出力するCSVファイルのファイル名を指定します（拡張子は不要）。デフォルトは `"batch_summary"` です。

**記述例:**
```python
# 「1.0μm未満」「1.0〜3.0μm」「3.0μm以上」の3つの区分で集計し、"my_result.csv" という名前で保存
batch_analyzer.output_summary_csv(ranges=[(None, 1.0), (1.0, 3.0), (3.0, None)], title="my_result")
```

#### 生データCSVの出力設定 (`output_diameter_csv`)

標準ではすべての粒子の直径データがCSVとして保存されますが、設定を変更することも可能です。

*   **`header=True/False`**: CSVファイルの1行目に列名（ヘッダー）を入れるかどうか（デフォルトはTrue）。

**記述例:**
```python
# ヘッダーなしでCSVを出力
batch_analyzer.output_diameter_csv(header=False)
```

#### その他の解析設定 (`run_analysis` および共通設定)

*   **`strict_tracking=True/False`** (`run_analysis`で使用):
    *   3Dスタック画像（スライス画像）を解析する場合、粒子がZ軸方向に繋がっているかを厳密に判定するかどうかを指定します。通常は `True` (デフォルト) のままで構いません。

*   **3D解析（Zスタック画像）向け共通オプション**:
    以下のオプションは、`plot_diameter_histogram`, `output_diameter_csv` などで共通して使えます。
    *   **`single_z=True/False`**: 特定のZスライス（深さ）1枚だけを解析対象とする場合に `True` にします。
    *   **`z=数値`**: `single_z=True` の場合に、何枚目のスライスを解析するか指定します（0から始まる番号）。



---

## 5. 困ったときは

*   **エラーが出た:**
    ターミナルに表示されたエラーメッセージ（英語の文字列）をコピーして、開発担当の方にご相談ください。
*   **設定値が分からない:**
    顕微鏡の撮影条件を確認し、特に`DOTS_PER_MICRON`（倍率に関する設定）が正しいかを確認してください。分からなければ、撮影時のスケールバーの情報などを添えてご相談ください。
