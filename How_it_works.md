# 画像から微小な粒子を検出する仕組み

このプログラムは、たくさんの断層写真（スライス画像）のセットを複数読み込み、それぞれのセットに含まれる小さな粒子を見つけ出し、その大きさや数を自動で測定するものです。まるで、複数の顕微鏡写真を一枚一枚じっくりと目で見て、定規で測る作業を、コンピュータが一括でやってくれるようなものです。

ここでは、その処理がどのような手順で行われているのかを、分かりやすく解説します。

## 全体の流れ

プログラムはまず、指定された画像セットの数だけ、以下の解析処理を一つずつ順番に実行します。そして最後に、すべての結果をまとめてレポートを出力します。

1.  **【ステップ1】写真から「粒子」だけをハッキリさせる（画像の前処理とセグメンテーション）**
    *   写真に写っている粒子以外の余計なものを取り除き、粒子と背景をくっきりと分けます。
2.  **【ステップ2】見つけた粒子の形と大きさを測る（円フィッティングとフィルタリング）**
    *   ハッキリさせた粒子の一つ一つが、どれくらいの大きさで、どれくらい「丸い」のかを測定します。
3.  **【ステップ3】断層写真を重ねて、同じ粒子を追いかける（粒子追跡）**
    *   パラパラ漫画のように、各断層写真に写っている粒子が、上下の層のどの粒子と繋がっているのかを判断し、立体的な一つの粒子として認識します。
4.  **【ステップ4】結果をレポートにまとめる（データ出力）**
    *   個々の画像セットに対して、見つけた粒子に色を塗った画像や、粒子の大きさの分布を示したグラフなどを作成します。
5.  **【ステップ5】全結果を集計して比較する（バッチ処理結果の出力）**
    *   全画像セットの解析結果を横断的に集計し、比較可能なレポートを作成します。

---

## 各ステップの詳細

### 【ステップ1】写真から「粒子」だけをハッキリさせる

このステップの目的は、元の写真から解析の邪魔になる情報（ノイズ）を取り除き、粒子とそれ以外の部分（背景）を白と黒の影絵のようにハッキリと分けることです。

1.  **影絵にする（二値化）**
    *   まず、写真を白と黒の2色だけにします。これにより、どこからどこまでが粒子なのかが明確になります。

2.  **お掃除（ノイズ除去）**
    *   影絵にすると、小さなゴミが写り込んだり、粒子の中に穴が空いてしまったりすることがあります。これらを綺麗に取り除き、粒子のかたまりをより正確に捉えます。

3.  **くっついた粒子を切り離す（Watershed法）**
    *   粒子同士がくっついて、一つの大きなかたまりに見えてしまうことがあります。これでは正確な大きさが測れません。
    *   そこで、「分水嶺（ぶんすいれい）」という考え方を使います。これは、山の頂上から水を流したときに、水が流れ落ちる範囲で領地を分けるようなイメージです。
    *   各粒子の中心（一番標高が高い場所）を見つけ、そこからじわじわと境界線を引いていくことで、くっついた粒子を綺麗に切り離します。

このステップが終わると、一つ一つの粒子が独立した島のように、くっきりと分かれた画像が出来上がります。

### 【ステップ2】見つけた粒子の形と大きさを測る

次に、切り離された個々の粒子について、その特徴を調べていきます。

1.  **円をあてはめてみる（円フィッティング）**
    *   プログラムは、一つ一つの粒子に対して、最もぴったりと合う「円」を探します。この円の半径から、粒子の「大きさ（直径）」を計算します。

2.  **「丸さ」で選別する（フィルタリング）**
    *   見つかった粒子の中には、形が歪すぎて粒子とは言えないものや、小さすぎるゴミのようなものが含まれているかもしれません。
    *   そこで、「理想的な円と比べて、どれくらい形が近いか（円形度）」や「設定した最小サイズよりも大きいか」といった基準でチェックを行い、条件に合わないものを除外します。

これにより、解析対象とすべき、質の良い粒子だけが残ります。

### 【ステップ3】断層写真を重ねて、同じ粒子を追いかける

私たちが見ているのは、物体を輪切りにした断層写真です。一つの粒子は、複数の断層写真にまたがって写っています。このステップでは、バラバラの断層写真に写った粒子の断片を、一つの立体的な粒子として繋ぎ合わせます。

1.  **上下の層を見比べる**
    *   まず、1枚目の断層写真に写っている粒子に、それぞれ番号を振ります。
    *   次に、2枚目の写真を見て、1枚目のどの粒子に一番近いかを調べます。

2.  **同じ粒子か判断する**
    *   もし、上下の層で非常に近い位置に粒子があれば、それは「同じ粒子が続いているもの」と判断し、同じ番号を振ります。
    *   もし、近くに対応する粒子がなければ、「新しい粒子が現れた」と判断し、新しい番号を振ります。

この作業を最後の断層写真まで繰り返すことで、どの粒子がどのようにつながっているのかが分かり、3次元的な粒子情報が完成します。

### 【ステップ4】結果をレポートにまとめる

最後に、これまでの解析で分かったことを、人間が見て分かりやすい形にまとめます。ここまでの処理は、画像セットごとに行われます。

1.  **結果の可視化**
    *   見つけ出した粒子に、それぞれ異なる色を塗った画像を生成します。これにより、どの粒子がどのように認識されたのかを直感的に確認できます。

2.  **グラフの作成（ヒストグラム）**
    *   測定した全粒子の「大きさ（直径）」を基に、「どのくらいの大きさの粒子が何個あったか」という分布を示すグラフを作成します。

3.  **数値データの一覧化（CSVファイル）**
    *   個々の粒子の直径データを、Excelなどで開ける一覧表（CSVファイル）として保存します。

### 【ステップ5】全結果を集計して比較する

すべての画像セットの解析が終わった後、プログラムは全体の結果を比較・集計するための特別なレポートを作成します。

1.  **グラフのスケールを統一して再出力**
    *   各画像セットのヒストグラム（粒子の大きさのグラフ）を、すべて同じ縦軸・横軸のスケールで描き直します。これにより、「Aの画像セットはBに比べて、全体的に粒子が大きい/小さい」といった比較が、一目で正確にできるようになります。

2.  **サマリー（要約）レポートの作成**
    *   各画像セットについて、「粒子の総数」「大きさの平均値、最大値、最小値」といった代表的な統計値を計算し、一つの表（CSVファイル）にまとめます。これにより、各データセットの重要な特徴を一覧で比較検討できます。

---

以上が、このプログラムが自動で行っている解析作業の全貌です。複雑な計算を個々の画像セットに対して行い、さらにそれらを集計・比較することで、人間には時間のかかる地道な作業を、高速かつ正確に実行しているのです。
